<!DOCTYPE html>
<html id="docs" lang="en" class="">
	<head>
	<meta charset="utf-8">
<title>Develop a hatchery - CDS - Continuous Delivery Service</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="../../../images/favicon.png">




<link rel="stylesheet" href="../../../sass/styles.css" integrity="" media="screen">
<link rel="stylesheet" href="../../../css/callouts.css">
<link rel="stylesheet" href="../../../css/auto-complete.css">
<link rel="stylesheet" href="../../../css/fontawesome.min.css">
<link rel="stylesheet" href="../../../css/asciinema-player.css">
<link rel="stylesheet" href="../../../css/solarized-light.css">

<meta name="description"
    content="Example with a creation of a vSphere hatchery   First of all you need to create a new package like the other into the hatchery package. Let&rsquo;s call this package vSphere for our example.
  You have to implement the Service interface (see here) in order to configure launch this new hatchery mode via CDS engine CLI.
  Your have to create a Configuration structure composed of the hatchery.">
<meta property="og:description"
    content="Example with a creation of a vSphere hatchery   First of all you need to create a new package like the other into the hatchery package. Let&rsquo;s call this package vSphere for our example.
  You have to implement the Service interface (see here) in order to configure launch this new hatchery mode via CDS engine CLI.
  Your have to create a Configuration structure composed of the hatchery.">
<meta name="twitter:description"
    content="Example with a creation of a vSphere hatchery   First of all you need to create a new package like the other into the hatchery package. Let&rsquo;s call this package vSphere for our example.
  You have to implement the Service interface (see here) in order to configure launch this new hatchery mode via CDS engine CLI.
  Your have to create a Configuration structure composed of the hatchery.">
<meta property="og:url" content="/development/contribute/hatchery/">
<meta property="og:title" content="Develop a hatchery">
<meta name="twitter:title" content="Develop a hatchery">
<meta name="twitter:image:alt" content="CDS - Continuous Delivery Service">
<meta property="og:image" content="/images/cds-transparent.png">
<script type="text/javascript" src="../../../js/anchor.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../../js/jquery-ui.min.js"></script>
<script type="text/javascript" src="../../../js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../js/highlight.pack.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="../../../js/script.js"></script>
<script type="text/javascript" src="../../../js/lunr.min.js"></script>
<a id="indexJSON" href="../../../index.json"></a>

<script type="text/javascript" src="../../../js/auto-complete.min.js"></script>
<script type="text/javascript" src="../../../js/search.js"></script>
<script type="text/javascript" src="../../../js/asciinema-player.min.js"></script>

	</head>
	<body>
		<section id="hero" class="light-text no-sub">
			<a href="../../../" class="logo"></a>
				<i id="tocburger" class="fa fa-bars" onclick='$("#toc").toggle()'></i><div class="nav-buttons" data-auto-burger="primary">
				<ul class="global-nav">
					
					
					<li><a href="../../../docs/">Documentation</a></li>
					
					<li><a href="../../../hosting/">Hosting your own instance</a></li>
					
					<li><a href="../../../development/" class="active">CDS Developer Manual</a></li>
					
					<li><a href="../../../about/">About</a></li>
					
					<li><i class="fa fa-search" onclick='$("#searchbox").toggle(); $("#search-query").focus().select()'></i></li>
					<li>
						<div id="btn-gh">
							<a class="github-button" href="https://github.com/ovh/cds" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star CDS on GitHub">Star</a>
							<script async defer src="https://buttons.github.io/buttons.js"></script>
						</div>
					</li>
				</ul>
				<div id="searchbox">
					<input data-search-input id="search-query" type="text" placeholder="search...">
					<span data-search-clear=""><i class="fa fa-close"></i></span>
				</div>
			</div>

<div id="headSubMenu" class="light-text">




	

		

		
	

	

		

		
	

	

		

		
		<ul>
			
			
			
			
				
				<li><a href="../../../development/rest/">REST API</a></li>
			
				
				<li><a href="../../../development/sdk/">SDK</a></li>
			
				
				<li><a href="../../../development/contribute/" class="menuSelected">Contributing</a></li>
			
		</ul>
		
	

	

		

		
	

</div>


		</section>
		<section id="page-content-with-menu">
			
<div id="toc">
     <div class="toc-container">
        
        
        
        
        
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
        
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
        
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                                    
                                    
                            
                        
                    
                
            
        
            
                
                    
                
            
        
        
        <i class="fa fa-bars" id="tocburger" onclick='$("#toc").toggle()'></i> 
<a class="item" data-title="Contributing" href="../../../development/contribute/"></a>

	
	
	
	
		
			
<a class="item" data-title="Write documentation" href="../../../development/contribute/documentation/"></a>

		
	
		
			
<a class="item" data-title="Develop a hatchery" href="../../../development/contribute/hatchery/"></a>

		
	
		
			
<a class="item" data-title="Development Environment" href="../../../development/contribute/development/"></a>

		
	
		
			
<a class="item" data-title="Develop a plugin" href="../../../development/contribute/plugin/"></a>

		
	
		
			
<a class="item" data-title="Error management" href="../../../development/contribute/error_management/"></a>

		
	





     </div>
</div>


			<div id="docsContent">
        		

<h1>Develop a hatchery</h1>



<nav id="TableOfContents">
  <ul>
    <li><a href="#example-with-a-creation-of-a-vsphere-hatchery">Example with a creation of a vSphere hatchery</a></li>
    <li><a href="#test">Test</a></li>
  </ul>
</nav>

<h2 id="example-with-a-creation-of-a-vsphere-hatchery">Example with a creation of a vSphere hatchery</h2>
<ul>
<li>
<p>First of all you need to create a new package like the other into the hatchery package. Let&rsquo;s call this package vSphere for our example.</p>
</li>
<li>
<p>You have to implement the Service interface (see <a href="https://github.com/ovh/cds/blob/v0.54.1/engine/types.go">here</a>) in order to configure launch this new hatchery mode via CDS engine CLI.</p>
</li>
<li>
<p>Your have to create a Configuration structure composed of the <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#CommonConfiguration">hatchery.CommonConfiguration</a> and the variables you need to access to vSphere API. You finally have to update the <a href="https://github.com/ovh/cds/blob/v0.54.1/engine/main.go">engine main.go file</a> to manage this new service and add and manage the configuration structure as part of the <a href="https://github.com/ovh/cds/blob/v0.54.1/engine/types.go">global configuration</a>.</p>
</li>
<li>
<p>You need to implement the hatchery interface (see <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#Interface">here</a>)</p>
</li>
<li>
<p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">Init</a> function is useful to create the struct and to set all of these parameters, for our example it&rsquo;s in this function that we&rsquo;re going to create all our vSphere information fetched from the vSphere API. (cf <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">init.go</a>). In this case we create a new vSphere client to request vSphere API, a new finder to fetch all information about our vSphere host. In fact, all information that we need to spawn and kill the vms with our workers inside on the vSphere infrastructure. This function is also used to create and register the hatchery on the API via the function in the sdk called <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#Register">hatchery.Register</a>. This register will give you the id of your hatchery.</p>
</li>
<li>
<p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.ID">ID</a> function returns the id of the current hatchery that comes from the hatchery client registered with the sdk previously in the <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">Init</a> function.</p>
</li>
<li>
<p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.ModelType">ModelType</a> function returns the type of the hatchery, in this case it&rsquo;s vSphere type. We can create a constant VSphere inside our <a href="https://godoc.org/github.com/ovh/cds/sdk#pkg-constants">sdk package</a>.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Hatchery">Hatchery</a> function returns the hatchery struct initialised previously in the <code>Init</code> function.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Client">Client</a> function returns the sdk client initialised previously in the <code>Init</code> function too.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.NeedRegistration">NeedRegistration</a> is used to know if your worker model need registration. For example if a user update a worker model you have to rebuild the virtual machine model linked to this worker model. And this function returns true if the worker model was updated after the virtual machine model was created on vSphere. In order to know that for vSphere we have add some metadata on each vms in order to add more custom data as the last creation of this vm for example.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.WorkersStartedByModel">WorkersStartedByModel</a> returns all workers which are running with a worker model. In our vSphere example, in order to know that we register a string metadata called model which tell us the name of our worker model.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.WorkersStarted">WorkersStarted</a> returns all workers include those which are running to build a vm model or to register a worker model. For example in the vSphere case, in order to count them we all prefix our worker spawned with <code>worker-</code>.</p>
</li>
<li>
<p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.CanSpawn">CanSpawn</a> is where the magic happens, it&rsquo;s in this function that you spawn your vms with the right configuration. In fact with vSphere we check if there is a vm model already created for the worker model passed in parameter. If it doesn&rsquo;t we create a vm model with the user data store in worker model infos. Then we spawn a vm with right environment variables created from information passed in parameters (workerModel, registerOnly, &hellip;) and with a script inside the vm that download the worker binary, execute it and shutdown when all is done. In this function we also check if the worker should be launch to register or to execute steps. When we launch a worker for register it means that the worker is launched and then send all there binary capabilities to the API for this worker model but don&rsquo;t execute any jobs.</p>
</li>
<li>
<p>In our vSphere implementation we also launch multiple goroutine to clean and kill workers which seem down or in error. It&rsquo;s a ticker that check all vms state in a periodic way.</p>
</li>
</ul>
<h2 id="test">Test</h2>
<p>If you want to test that you just have to launch it like that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ engine start hatchery:vsphere --config config.toml
</code></pre></div>



			</div>
		</section><footer>
			<main>
			<a href="https://www.ovh.com"><img src="https://ovh.github.io/cds/images/logo-ovh-white-72DPI.png"></a>
			<div>
				The CDS logos are copyrighted.
				Icons made by <a href="https://www.flaticon.com/authors/eucalyp">Eucalyp</a> 
				from <a href="https://www.flaticon.com/">www.flaticon.com</a>
			</div>
			</main>
		</footer>

	</body>
</html>
